{% extends 'base.html' %}
{% load static %}

{% block content %}
<p class="fs-1">Book an Appointment</p>
<form method="POST" id="appointmentForm" class="w-25">
    {% csrf_token %}
    <div class="mb-3">
        <label for="id_specialty" class="form-label"><strong>Specialty</strong></label>
        {{ form.specialty }}
    </div>

    <div class="mb-3">
        <label for="id_date" class="form-label"><strong>Date</strong></label>
        {{ form.date }}
    </div>

    <div id="slots" class="mt-4">
        <p>Select a date to see available times.</p>
    </div>

    <input type="hidden" name="time" id="id_time">
    <button type="submit" class="btn btn-primary mt-3">Book Appointment</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.querySelector('#id_date');
        const specialtyInput = document.querySelector('#id_specialty');
        const slotsDiv = document.querySelector('#slots');
        const timeField = document.querySelector('#id_time');

        function loadSlots() {
            const date = dateInput.value;
            const specialty = specialtyInput.value;
            if (!date || !specialty) return;

            fetch(`/get-slots/?date=${date}&specialty=${specialty}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        slotsDiv.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }

                    slotsDiv.innerHTML = data.slots.map(slot => `
                    <button type="button"
                        class="btn btn-sm m-1 ${slot.available ? 'btn-outline-success' : 'btn-secondary'}"
                        ${slot.available ? '' : 'disabled'}
                        onclick="selectSlot('${slot.time}')">${slot.time}</button>
                `).join('');
                });
        }

        dateInput.addEventListener('change', loadSlots);
        specialtyInput.addEventListener('change', loadSlots);

        window.selectSlot = function (time) {
            timeField.value = time;
            document.querySelectorAll('#slots button').forEach(btn => btn.classList.remove('btn-success'));
            event.target.classList.add('btn-success');
        };
    });
</script>
{% endblock %}